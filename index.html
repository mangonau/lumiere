<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LumiÃ¨re</title>
    <meta name="apple-mobile-web-app-title" content="LumiÃ¨re">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f7f5f0">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23d68c78'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='serif' font-size='300' fill='white'%3EL%3C/text%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=Lato:wght@300;400&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { serif: ['"Noto Serif TC"', 'serif'], sans: ['"Lato"', 'sans-serif'], display: ['"Playfair Display"', 'serif'] }, colors: { 'paper': '#f7f5f0', 'ink': '#2c2c2c', 'sage': '#84a98c', 'terra': '#d68c78', 'sand': '#eaddcf' } } } }
    </script>
    <style>
        body { font-family: 'Lato', 'Noto Serif TC', sans-serif; background-color: #f7f5f0; color: #2c2c2c; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .dark body { background-color: #1a1a1a; color: #e5e5e5; }
        .texture-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 20px 20px; }
        .dark .texture-bg { opacity: 0.1; background-image: radial-gradient(#555 1px, transparent 1px); }
        .paper-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05); }
        .dark .paper-card { background: rgba(40, 40, 40, 0.7); border: 1px solid rgba(255, 255, 255, 0.05); }
        .elegant-input { border: none; background: transparent; border-bottom: 1px solid #d1d5db; padding: 10px 0; outline: none; transition: 0.3s; color: #4b5563; }
        .elegant-input:focus { border-bottom-color: #d68c78; }
        .dark .elegant-input { border-bottom-color: #555; color: #eee; }
        .page-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; padding-top: 10px; animation: fadeIn 0.3s ease-out; }
        .page-content.active { display: block; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; border-radius: 8px; cursor: pointer; position: relative; }
        .cal-day.today { background-color: #eaddcf; font-weight: bold; }
        .cal-day.has-data::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background-color: #d68c78; border-radius: 50%; }
        .nav-icon { transition: all 0.3s; font-size: 1.2rem; }
        .nav-active .nav-icon { transform: translateY(-3px); color: #d68c78; }
        .nav-label { font-size: 9px; margin-top: 2px; letter-spacing: 0.05em; transition: color 0.3s; }
        .nav-active .nav-label { color: #d68c78; font-weight: bold; }
        
        /* Loading Overlay Improved */
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 90; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .dark #loadingOverlay { background: rgba(0,0,0,0.95); }
        #errorBox { display: none; margin-top: 20px; padding: 15px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 10px; color: #b91c1c; font-size: 12px; max-width: 80%; text-align: center; }
        
        /* Lock Screen */
        #lockScreen { position: fixed; inset: 0; background: #f7f5f0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .dark #lockScreen { background: #1a1a1a; }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #d68c78; transition: 0.2s; }
        .pin-dot.filled { background: #d68c78; }
        .keypad-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 20px; font-family: 'Playfair Display'; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.5); margin: 8px; active:scale-95; cursor: pointer; }
        .dark .keypad-btn { background: rgba(255,255,255,0.1); color: white; }
    </style>
</head>
<body>
    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âœ… Firebase Config (å¾ä½ æä¾›çš„è³‡è¨Šå¡«å…¥)
        const firebaseConfig = {
            apiKey: "AIzaSyBhassa0kIlzdot1yBDoQw-UxMihQKrVjk",
            authDomain: "lumiere-bb65c.firebaseapp.com",
            projectId: "lumiere-bb65c",
            storageBucket: "lumiere-bb65c.firebasestorage.app",
            messagingSenderId: "117730167982",
            appId: "1:117730167982:web:2dde374c42300c18d7713f"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.collection = collection;
            window.addDoc = addDoc;
            window.getDocs = getDocs;
            window.onSnapshot = onSnapshot; 
            window.updateDoc = updateDoc;
            window.deleteDoc = deleteDoc;
            window.doc = doc;
            window.query = query;
            window.orderBy = orderBy;
            
            console.log("Firebase initialized");
            window.initApp(); 
        } catch (e) {
            document.getElementById('loadingText').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—";
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `Config éŒ¯èª¤: ${e.message}`;
        }
    </script>

    <div class="texture-bg"></div>

    <!-- Lock Screen -->
    <div id="lockScreen">
        <h1 class="font-serif italic text-3xl mb-8 text-ink dark:text-white">LumiÃ¨re</h1>
        <p id="lockMsg" class="text-xs text-gray-400 mb-6">Enter PIN</p>
        <div class="flex gap-4 mb-10"><div class="pin-dot" id="dot1"></div><div class="pin-dot" id="dot2"></div><div class="pin-dot" id="dot3"></div><div class="pin-dot" id="dot4"></div></div>
        <div class="grid grid-cols-3 gap-2">
            <div class="keypad-btn" onclick="enterPin(1)">1</div><div class="keypad-btn" onclick="enterPin(2)">2</div><div class="keypad-btn" onclick="enterPin(3)">3</div>
            <div class="keypad-btn" onclick="enterPin(4)">4</div><div class="keypad-btn" onclick="enterPin(5)">5</div><div class="keypad-btn" onclick="enterPin(6)">6</div>
            <div class="keypad-btn" onclick="enterPin(7)">7</div><div class="keypad-btn" onclick="enterPin(8)">8</div><div class="keypad-btn" onclick="enterPin(9)">9</div>
            <div class="keypad-btn opacity-0"></div><div class="keypad-btn" onclick="enterPin(0)">0</div><div class="keypad-btn" onclick="enterPin('del')"><i class="fas fa-backspace text-sm"></i></div>
        </div>
        <button onclick="forgetPin()" class="mt-8 text-xs text-gray-300 underline">å¿˜è¨˜å¯†ç¢¼?</button>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div id="loadingSpinner" class="animate-spin rounded-full h-10 w-10 border-b-2 border-terra"></div>
        <p id="loadingText" class="text-xs text-gray-500 mt-4 animate-pulse">æ­£åœ¨åŒæ­¥è³‡æ–™åº«...</p>
        <div id="errorBox"></div>
        <button id="retryBtn" onclick="location.reload()" class="hidden mt-4 px-4 py-2 bg-ink text-white rounded-lg text-xs">é‡æ–°é€£ç·š</button>
        <button id="forceEntryBtn" onclick="forceEntry()" class="hidden mt-2 px-4 py-2 text-gray-400 border border-gray-300 rounded-lg text-xs">å¼·åˆ¶é€²å…¥ (é›¢ç·šç€è¦½)</button>
    </div>

    <!-- Main Content -->
    <div class="w-full h-full max-w-md mx-auto relative z-10 p-5 pt-8 flex flex-col">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h1 class="font-serif text-2xl font-bold tracking-wider text-ink dark:text-gray-100">LumiÃ¨re</h1>
            <div class="flex gap-3">
                <button onclick="window.location.reload()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-terra transition"><i class="fas fa-sync-alt"></i></button>
                <button id="themeToggle" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 transition"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block text-yellow-300"></i></button>
            </div>
        </div>

        <!-- PAGE 0: Home -->
        <div id="page-home" class="page-content active scrollbar-hide">
            <div class="mb-6 mt-2"><p class="text-xs text-gray-400 tracking-widest uppercase mb-1" id="dateDisplay">DATE</p><h2 class="text-3xl font-serif text-ink dark:text-white" id="greeting">Hello.</h2></div>
            <div class="paper-card rounded-2xl p-6 mb-6 relative overflow-hidden">
                <p class="text-[10px] text-gray-400 uppercase tracking-[0.2em] mb-2">Net Worth</p>
                <h3 class="font-serif italic text-4xl text-ink dark:text-white mb-4" id="netWorth">...</h3>
                <div class="flex gap-2">
                    <div class="flex-1 bg-white/50 dark:bg-white/5 p-3 rounded-xl"><p class="text-[10px] text-gray-400">ç¸½è³‡ç”¢</p><p class="font-bold text-sage text-lg" id="totalAsset">...</p></div>
                    <div class="flex-1 bg-white/50 dark:bg-white/5 p-3 rounded-xl"><p class="text-[10px] text-gray-400">ç¸½è² å‚µ</p><p class="font-bold text-terra text-lg" id="totalDebt">...</p></div>
                </div>
            </div>
            <div class="paper-card rounded-xl p-4 mb-6"><h4 class="text-xs text-gray-400 uppercase tracking-widest mb-4">è³‡ç”¢è¶¨å‹¢</h4><div class="h-40 relative"><canvas id="netWorthChart"></canvas></div></div>
            <div class="paper-card rounded-xl p-4 mb-6 space-y-4">
                <div><div class="flex justify-between text-xs mb-1"><span class="text-gray-500">æœ¬æœˆæ”¶å…¥</span><span class="font-bold text-sage" id="homeIncome">$0</span></div><div class="w-full bg-gray-100 dark:bg-gray-700 h-1.5 rounded-full overflow-hidden"><div class="bg-sage h-full rounded-full" style="width: 0%" id="barIncome"></div></div></div>
                <div><div class="flex justify-between text-xs mb-1"><span class="text-gray-500">æœ¬æœˆæ”¯å‡º</span><span class="font-bold text-terra" id="homeExpense">$0</span></div><div class="w-full bg-gray-100 dark:bg-gray-700 h-1.5 rounded-full overflow-hidden"><div class="bg-terra h-full rounded-full" style="width: 0%" id="barExpense"></div></div></div>
            </div>
            <button onclick="switchTab('record', document.getElementById('nav-record'))" class="w-full py-4 rounded-xl bg-ink text-white dark:bg-white dark:text-black shadow-lg active:scale-95 transition flex items-center justify-center gap-2 group"><span class="font-serif tracking-widest text-sm">é–‹å§‹è¨˜å¸³</span><i class="fas fa-arrow-right group-hover:translate-x-1 transition"></i></button>
        </div>

        <!-- PAGE 1: Record -->
        <div id="page-record" class="page-content scrollbar-hide">
            <div id="recordFormContainer" class="paper-card rounded-2xl p-6 mb-6 relative">
                <input type="hidden" id="editId">
                <div class="flex gap-2 mb-5 border-b border-gray-100 dark:border-gray-700 pb-2">
                    <button type="button" class="flex-1 text-sm font-bold pb-2 border-b-2 border-terra text-terra transition" id="btnExpense" onclick="setFormType('æ”¯å‡º')">æ”¯å‡º</button>
                    <button type="button" class="flex-1 text-sm text-gray-400 pb-2 transition" id="btnIncome" onclick="setFormType('æ”¶å…¥')">æ”¶å…¥</button>
                    <button type="button" class="flex-1 text-sm text-gray-400 pb-2 transition" id="btnTransfer" onclick="setFormType('è½‰å¸³')">è½‰å¸³</button>
                </div>
                <form id="financeForm" class="space-y-4">
                    <input type="hidden" id="formType" value="æ”¯å‡º">
                    <div class="flex gap-4"><input type="date" id="dateInput" class="elegant-input w-[40%] text-sm font-serif" required><div class="w-[60%]"><select id="accountInput" class="elegant-input w-full text-sm bg-transparent cursor-pointer" required></select><p class="text-[9px] text-gray-400 mt-1" id="fromLabel">å¾æ­¤å¸³æˆ¶æ‰£æ¬¾</p></div></div>
                    <div id="toAccountField" class="hidden"><select id="toAccountInput" class="elegant-input w-full text-sm bg-transparent cursor-pointer"></select><p class="text-[9px] text-gray-400 mt-1">è½‰å…¥è‡³æ­¤å¸³æˆ¶</p></div>
                    <div class="flex gap-4" id="normalFields"><select id="categoryInput" class="elegant-input w-[40%] text-sm bg-transparent cursor-pointer"></select><input type="text" id="itemInput" placeholder="é …ç›®å…§å®¹..." class="elegant-input w-[60%] text-sm"></div>
                    <div class="relative"><span class="absolute top-2 left-0 text-lg text-gray-400 font-serif">$</span><input type="number" id="amountInput" placeholder="0" class="elegant-input w-full pl-6 text-2xl font-serif text-ink dark:text-white" required></div>
                    <div class="flex items-center gap-2 mt-2" id="claimSection"><input type="checkbox" id="isClaimable" class="w-4 h-4 rounded border-gray-300 text-terra focus:ring-terra"><label for="isClaimable" class="text-xs text-gray-500">æ¨™è¨˜ç‚ºä»£å¢Šæ¬¾ (å ±å¸³ç”¨)</label></div>
                    <div class="flex gap-2"><button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="hidden w-1/3 mt-2 bg-gray-200 text-gray-600 py-3 rounded-xl text-sm">å–æ¶ˆ</button><button type="submit" id="submitBtn" class="w-full mt-2 bg-ink dark:bg-gray-200 text-white dark:text-gray-900 py-3 rounded-xl shadow-lg active:scale-95 transition font-serif tracking-widest text-sm">è¨˜ä¸Šä¸€ç­†</button></div>
                </form>
            </div>
            <div class="relative mb-4"><i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i><input type="text" id="searchInput" placeholder="æœå°‹ç´€éŒ„..." class="w-full bg-white/50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-xl py-2.5 pl-9 pr-4 text-sm outline-none focus:border-terra transition" onkeyup="renderTransactionList()"></div>
            <div id="transactionList" class="space-y-3 pb-10"><div class="text-center text-gray-400 text-xs py-10 font-serif italic">Loading...</div></div>
        </div>

        <!-- PAGE 2: Assets -->
        <div id="page-assets" class="page-content scrollbar-hide">
            <div class="flex justify-between items-end mb-4 px-1"><h3 class="font-serif text-lg text-ink dark:text-white pl-3 border-l-2 border-gray-400">è³‡ç”¢ç¸½è¦½</h3><button onclick="openAccountModal()" class="text-xs bg-ink text-white dark:bg-white dark:text-black px-3 py-1.5 rounded-lg shadow active:scale-95 transition"><i class="fas fa-plus mr-1"></i> å¸³æˆ¶</button></div>
            <div class="mb-6"><h4 class="text-xs text-gray-400 font-bold mb-2 pl-2">ç¾é‡‘èˆ‡éŠ€è¡Œ</h4><div id="bankList" class="space-y-3"></div></div>
            <div><h4 class="text-xs text-gray-400 font-bold mb-2 pl-2">ä¿¡ç”¨å¡èˆ‡è² å‚µ</h4><div id="creditList" class="space-y-3"></div></div>
        </div>

        <!-- PAGE 3: Stats -->
        <div id="page-stats" class="page-content scrollbar-hide">
            <h3 class="font-serif text-lg text-ink dark:text-white mb-4 pl-3 border-l-2 border-sage">æ”¶æ”¯åˆ†æ</h3>
            <div class="paper-card rounded-2xl p-5 mb-6"><h4 class="text-xs text-gray-400 uppercase tracking-widest mb-4 text-center">æœ¬æœˆæ”¯å‡ºåˆ†ä½ˆ</h4><div class="h-64 relative"><canvas id="categoryChart"></canvas></div></div>
            <div class="flex justify-between items-end mb-4 mt-8 px-1"><h3 class="font-serif text-lg text-ink dark:text-white pl-3 border-l-2 border-terra">åˆ†é¡é ç®—</h3><button onclick="openBudgetModal()" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded-lg shadow-sm active:scale-95 transition dark:bg-gray-700 dark:border-gray-600 dark:text-white">è¨­å®š</button></div>
            <div id="budgetList" class="space-y-4 mb-8"></div>
        </div>

        <!-- PAGE 4: Manage -->
        <div id="page-manage" class="page-content scrollbar-hide">
            <div class="flex justify-between items-end mb-4 px-1"><h3 class="font-serif text-lg text-ink dark:text-white pl-3 border-l-2 border-clay">å›ºå®šæ”¶æ”¯</h3><button onclick="openRecurringModal()" class="text-xs bg-ink text-white dark:bg-white dark:text-black px-3 py-1.5 rounded-lg shadow active:scale-95 transition"><i class="fas fa-plus mr-1"></i> æ–°å¢</button></div>
            <div id="recurringList" class="space-y-3 mb-8"><p class="text-center text-gray-400 text-xs py-4">ç„¡è³‡æ–™</p></div>
            <h3 class="font-serif text-lg text-ink dark:text-white mb-4 pl-3 border-l-2 border-terra">å¾…æ ¸éŠ·æ¸…å–®</h3>
            <div id="claimAlert" class="hidden paper-card rounded-xl p-3 mb-4 border-l-4 border-terra flex justify-between items-center"><span class="text-xs text-terra font-bold tracking-wide">ä»£å¢Šæ¬¾é … (å¾…æ ¸éŠ·)</span><div class="flex items-center gap-2"><span id="claimAmount" class="font-serif text-lg text-terra">$0</span></div></div>
            <div id="claimList" class="space-y-3 pb-10"></div>
            <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                <button onclick="exportCSV()" class="w-full py-3 text-xs text-blue-500 border border-blue-200 rounded-xl mb-3">åŒ¯å‡º CSV</button>
                <button onclick="resetPin()" class="w-full py-3 text-xs text-gray-400 border border-gray-300 rounded-xl">é‡è¨­ PIN ç¢¼</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="recurringModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="paper-card w-full max-w-xs rounded-2xl p-6 shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="recModalContent"><h3 class="text-lg font-serif font-bold mb-4 text-center">è¨­å®šå›ºå®šé …ç›®</h3><form id="recurringForm" class="space-y-3"><input type="text" id="recItem" placeholder="é …ç›®" class="elegant-input w-full text-sm" required><div class="flex gap-2"><select id="recType" class="elegant-input w-1/3 text-sm" onchange="updateRecCats()"><option value="æ”¯å‡º">æ”¯å‡º</option><option value="æ”¶å…¥">æ”¶å…¥</option></select><select id="recCategory" class="elegant-input w-2/3 text-sm"></select></div><div class="flex gap-2"><input type="number" id="recAmount" placeholder="é‡‘é¡" class="elegant-input w-1/2 text-sm" required><div class="w-1/2 flex items-center border-b border-gray-300"><span class="text-xs text-gray-400 mr-1">æ¯æœˆ</span><input type="number" id="recDay" placeholder="5" min="1" max="31" class="bg-transparent outline-none w-full text-sm" required><span class="text-xs text-gray-400">è™Ÿ</span></div></div><select id="recAccount" class="elegant-input w-full text-sm"></select><div class="flex gap-2 mt-4 pt-2"><button type="button" onclick="closeModal('recurringModal')" class="flex-1 py-2 text-xs text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button><button type="submit" class="flex-1 py-2 text-xs bg-ink text-white rounded-lg shadow">å„²å­˜</button></div></form></div></div>
    <div id="accountModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="paper-card w-full max-w-xs rounded-2xl p-6 shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="accModalContent"><h3 class="text-lg font-serif font-bold mb-4 text-center">æ–°å¢å¸³æˆ¶</h3><form id="accountForm" class="space-y-3"><input type="text" id="accName" placeholder="å¸³æˆ¶åç¨±" class="elegant-input w-full text-sm" required><select id="accType" class="elegant-input w-full text-sm" onchange="toggleDeadline()"><option value="bank">éŠ€è¡Œå¸³æˆ¶ / ç¾é‡‘</option><option value="credit">ä¿¡ç”¨å¡</option></select><input type="number" id="accInitial" placeholder="åˆå§‹é‡‘é¡ / é¡åº¦" class="elegant-input w-full text-sm" required><div id="deadlineField" class="hidden flex items-center border-b border-gray-300"><span class="text-xs text-gray-400 mr-2">æ¯æœˆ</span><input type="number" id="accDeadline" placeholder="27" min="1" max="31" class="bg-transparent outline-none w-10 border-b text-center"><span class="text-xs text-gray-400">è™Ÿç¹³æ¬¾</span></div><div class="flex gap-2 mt-4 pt-2"><button type="button" onclick="closeModal('accountModal')" class="flex-1 py-2 text-xs text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button><button type="submit" id="accSubmitBtn" class="flex-1 py-2 text-xs bg-ink text-white rounded-lg shadow">å„²å­˜</button></div></form></div></div>
    <div id="budgetModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="paper-card w-full max-w-xs rounded-2xl p-6 shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="budModalContent"><h3 class="text-lg font-serif font-bold mb-4 text-center">è¨­å®šåˆ†é¡é ç®—</h3><form id="budgetForm" class="space-y-3"><div class="relative"><span class="text-xs text-gray-400">åˆ†é¡</span><select id="budCategory" class="elegant-input w-full text-sm mt-1" required></select></div><div class="relative"><span class="text-xs text-gray-400">æ¯æœˆé™é¡</span><input type="number" id="budAmount" placeholder="15000" class="elegant-input w-full text-sm mt-1" required></div><div class="flex gap-2 mt-6"><button type="button" onclick="closeModal('budgetModal')" class="flex-1 py-2 text-xs text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button><button type="submit" class="flex-1 py-2 text-xs bg-ink text-white rounded-lg shadow">è¨­å®š</button></div></form></div></div>
    <div id="actionModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"><div class="paper-card w-full max-w-xs rounded-2xl p-6 text-center shadow-xl"><h3 class="font-bold mb-4" id="actionTitle">ç®¡ç†ç´€éŒ„</h3><div class="space-y-3"><button onclick="triggerEdit()" class="w-full py-3 bg-ink text-white rounded-xl text-sm">ç·¨è¼¯å…§å®¹</button><button onclick="triggerDelete()" class="w-full py-3 border border-red-200 text-red-500 rounded-xl text-sm">åˆªé™¤</button><button onclick="document.getElementById('actionModal').classList.add('hidden')" class="w-full py-2 text-gray-400 text-xs">å–æ¶ˆ</button></div></div></div>

    <div class="fixed bottom-0 left-0 w-full bg-[#f7f5f0]/95 dark:bg-[#1a1a1a]/95 backdrop-blur border-t border-gray-200 dark:border-gray-800 flex justify-around py-3 z-40 safe-area-bottom">
        <div class="nav-btn nav-active cursor-pointer w-16 text-center" onclick="switchTab('home', this)"><i class="fas fa-home nav-icon block mb-1"></i><span class="nav-label text-gray-400">é¦–é </span></div>
        <div id="nav-record" class="nav-btn cursor-pointer w-16 text-center" onclick="switchTab('record', this)"><i class="fas fa-pen-nib nav-icon block mb-1"></i><span class="nav-label text-gray-400">è¨˜å¸³</span></div>
        <div class="nav-btn cursor-pointer w-16 text-center" onclick="switchTab('assets', this)"><i class="fas fa-wallet nav-icon block mb-1"></i><span class="nav-label text-gray-400">è³‡ç”¢</span></div>
        <div class="nav-btn cursor-pointer w-16 text-center" onclick="switchTab('stats', this)"><i class="fas fa-chart-pie nav-icon block mb-1"></i><span class="nav-label text-gray-400">çµ±è¨ˆ</span></div>
        <div class="nav-btn cursor-pointer w-16 text-center" onclick="switchTab('manage', this)"><i class="fas fa-sliders-h nav-icon block mb-1"></i><span class="nav-label text-gray-400">ç®¡ç†</span></div>
    </div>

    <script>
        // Init Global Arrays
        let allRecords=[], allRecurring=[], myAccounts=[], myBudgets=[], calculatedStats={}, chartInstances={};
        let currentPin = '', storedPin = localStorage.getItem('lumiere_pin');
        let selectedRecordId = null;
        let unsubscribe = [];

        const categories = { 'æ”¯å‡º': ['é£²é£Ÿ', 'äº¤é€š', 'è³¼ç‰©', 'å¨›æ¨‚', 'å±…ä½', 'é†«ç™‚', 'å­¸ç¿’', 'å…¬å¸ä»£å¢Š', 'å…¶ä»–'], 'æ”¶å…¥': ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¬å¸æ’¥æ¬¾', 'å…¶ä»–'] };

        // Firebase logic will wait for window.db to be ready
        window.initApp = async function() {
            if(!storedPin) document.getElementById('lockMsg').innerText = "Create PIN";
            initDateDisplay(); document.getElementById('dateInput').valueAsDate = new Date();
            // Start Realtime Listeners
            setupRealtimeListeners();
        };

        function initDateDisplay() {
            const now = new Date(); const hour = now.getHours();
            let greet = "Good Morning."; if(hour>=12 && hour<18) greet="Good Afternoon."; else if(hour>=18) greet="Good Evening.";
            document.getElementById('greeting').innerText = greet;
            document.getElementById('dateDisplay').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        // ğŸ”¥ REALTIME LISTENERS (Improved with Error Handling)
        function setupRealtimeListeners() {
            // Loading start
            document.getElementById('loadingOverlay').classList.remove('hidden');
            let loadedCount = 0;
            const checkLoaded = () => { loadedCount++; if(loadedCount >= 4) document.getElementById('loadingOverlay').classList.add('hidden'); };
            
            // Timeout Fallback (5 seconds)
            setTimeout(() => { document.getElementById('loadingOverlay').classList.add('hidden'); }, 5000);

            // Helper for handling snapshots
            const handleSnap = (snap, type) => {
                const data = snap.docs.map(d => ({id: d.id, ...d.data(), amount: Number(d.data().amount || 0), initial: Number(d.data().initial || 0)}));
                if(type==='records') allRecords = data;
                if(type==='accounts') myAccounts = data;
                if(type==='recurring') allRecurring = data;
                if(type==='budgets') myBudgets = data;
                updateUI(); checkLoaded();
            };
            
            const handleError = (e) => {
                console.error("Firebase Error:", e);
                const errBox = document.getElementById('errorBox');
                errBox.style.display = 'block';
                errBox.innerHTML = `<strong>è®€å–éŒ¯èª¤</strong><br>${e.code}<br>è«‹æª¢æŸ¥ Firestore è¦å‰‡`;
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('retryBtn').classList.remove('hidden');
                document.getElementById('forceEntryBtn').classList.remove('hidden');
            };

            // 1. Records
            const qRec = window.query(window.collection(window.db, "records"), window.orderBy("timestamp", "desc"));
            unsubscribe.push(window.onSnapshot(qRec, (s) => handleSnap(s, 'records'), handleError));

            // 2. Accounts
            unsubscribe.push(window.onSnapshot(window.collection(window.db, "accounts"), (s) => handleSnap(s, 'accounts'), handleError));

            // 3. Recurring
            unsubscribe.push(window.onSnapshot(window.collection(window.db, "recurring"), (s) => handleSnap(s, 'recurring'), handleError));

            // 4. Budgets
            unsubscribe.push(window.onSnapshot(window.collection(window.db, "budgets"), (s) => handleSnap(s, 'budgets'), handleError));
        }

        function forceEntry() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        // Update All UI Components
        function updateUI() {
            updateDropdowns();
            const stats = calculateStats();
            renderHome(stats);
            renderTransactionList();
            renderAssets(stats);
            renderStats(stats);
            renderManage();
        }

        // Logic
        function updateDropdowns() {
            const opts = myAccounts.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
            document.getElementById('accountInput').innerHTML = opts; document.getElementById('toAccountInput').innerHTML = opts; document.getElementById('recAccount').innerHTML = opts;
            updateCategories(); updateRecCats();
            document.getElementById('budCategory').innerHTML = categories['æ”¯å‡º'].map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function calculateStats() {
            let stats = {}, totalClaim = 0, mIncome = 0, mExpense = 0; const now = new Date();
            myAccounts.forEach(a => stats[a.name] = { val: a.type=='bank'?a.initial:0, type: a.type, initial: a.initial, deadline: a.deadline, mExp: 0, mInc: 0 });
            allRecords.forEach(r => {
                let amt = Number(r.amount); const rd = new Date(r.date);
                const isThisMonth = rd.getMonth()===now.getMonth() && rd.getFullYear()===now.getFullYear();
                if(stats[r.account]) {
                    if (r.type === 'è½‰å¸³') {
                        stats[r.account].val += (stats[r.account].type=='bank' ? -amt : amt); 
                        if(r.toAccount && stats[r.toAccount]) stats[r.toAccount].val += (stats[r.toAccount].type=='bank' ? amt : -amt);
                    } else if (r.type === 'æ”¯å‡º') {
                        stats[r.account].val += (stats[r.account].type=='bank' ? -amt : amt); 
                        if(isThisMonth) stats[r.account].mExp += amt;
                        if(r.isClaimable && !r.isReimbursed) totalClaim += amt;
                    } else { 
                        stats[r.account].val += (stats[r.account].type=='bank' ? amt : -amt); 
                        if(isThisMonth) stats[r.account].mInc += amt;
                    }
                }
                if(isThisMonth && r.type !== 'è½‰å¸³') { if(r.type === 'æ”¯å‡º') mExpense += amt; else mIncome += amt; }
            });
            return { stats, totalClaim, mIncome, mExpense };
        }

        function renderHome(stats) {
            const { totalClaim, mIncome, mExpense } = stats;
            calculatedStats = stats.stats; // Store for assets page
            
            let totalAsset = 0, totalDebt = 0;
            Object.values(calculatedStats).forEach(s => { if(s.type === 'bank') totalAsset += s.val; else totalDebt += s.val; });
            document.getElementById('netWorth').innerText = `$${formatMoney(totalAsset - totalDebt)}`;
            document.getElementById('totalAsset').innerText = `$${formatMoney(totalAsset)}`;
            document.getElementById('totalDebt').innerText = `$${formatMoney(totalDebt)}`;
            document.getElementById('homeIncome').innerText = `+${formatMoney(mIncome)}`;
            document.getElementById('homeExpense').innerText = `-${formatMoney(mExpense)}`;
            let maxBar = Math.max(mIncome, mExpense, 1000); 
            document.getElementById('barIncome').style.width = `${Math.min((mIncome/maxBar)*100, 100)}%`;
            document.getElementById('barExpense').style.width = `${Math.min((mExpense/maxBar)*100, 100)}%`;
            renderNetWorthChart(totalAsset - totalDebt);
            const claimEl = document.getElementById('claimAlert');
            if(totalClaim>0) { claimEl.classList.remove('hidden'); document.getElementById('claimAmount').innerText = `$${formatMoney(totalClaim)}`; } else claimEl.classList.add('hidden');
        }

        function renderAssets() {
            const bankList = document.getElementById('bankList');
            const creditList = document.getElementById('creditList');
            bankList.innerHTML = ''; creditList.innerHTML = '';
            
            if(myAccounts.length === 0) {
                bankList.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">è«‹é»æ“Šä¸Šæ–¹ + æ–°å¢å¸³æˆ¶</p>';
                return;
            }

            myAccounts.forEach(acc => {
                const stat = calculatedStats[acc.name] || { val: acc.initial, type: acc.type };
                const div = document.createElement('div');
                div.className = 'paper-card p-4 rounded-xl flex justify-between items-center relative group';
                
                if(acc.type === 'bank') {
                    div.innerHTML = `<div><div class="font-bold text-sm text-ink dark:text-white mb-1"><i class="fas fa-wallet text-gray-400 mr-2"></i>${acc.name}</div></div><div class="text-right"><div class="font-serif font-bold text-sage text-lg">$${formatMoney(stat.val)}</div><button onclick="deleteData('accounts', '${acc.id}')" class="text-gray-300 hover:text-red-400 absolute top-4 right-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></div>`;
                    bankList.appendChild(div);
                } else {
                    let used = stat.val;
                    let remaining = acc.initial - used;
                    let percent = Math.min((used / acc.initial)*100, 100);
                    div.innerHTML = `<div><div class="font-bold text-sm text-ink dark:text-white mb-1"><i class="fas fa-credit-card text-gray-400 mr-2"></i>${acc.name}</div><div class="w-24 bg-gray-200 h-1 mt-2 rounded-full"><div class="bg-terra h-full rounded-full" style="width:${percent}%"></div></div></div><div class="text-right"><div class="font-serif font-bold text-terra text-lg">$${formatMoney(used)}</div><div class="text-[9px] text-gray-400">Used</div><button onclick="deleteData('accounts', '${acc.id}')" class="text-gray-300 hover:text-red-400 absolute top-4 right-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></div>`;
                    creditList.appendChild(div);
                }
            });
        }

        function renderTransactionList() {
            const list = document.getElementById('transactionList'); list.innerHTML = '';
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            let displayData = allRecords.filter(r => (r.item||'').toLowerCase().includes(keyword) || (r.category||'').toLowerCase().includes(keyword));
            
            if(displayData.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 text-xs py-10">æ²’æœ‰ç´€éŒ„</div>'; return; }

            displayData.slice(0, 50).forEach((r) => {
                const isExp = r.type === 'æ”¯å‡º', isTransfer = r.type === 'è½‰å¸³';
                let iconClass = isExp ? 'bg-[#fcece9] text-terra' : (isTransfer ? 'bg-gray-100 text-gray-500' : 'bg-[#eaf4ed] text-sage');
                let icon = isExp ? 'fa-shopping-bag' : (isTransfer ? 'fa-exchange-alt' : 'fa-seedling');
                let amountColor = isExp ? 'text-terra' : (isTransfer ? 'text-gray-500' : 'text-sage');
                let sign = isExp ? '-' : (isTransfer ? '' : '+');
                const div = document.createElement('div'); div.className = 'paper-card p-3 rounded-xl flex justify-between items-center mb-2 cursor-pointer hover:bg-white/50';
                div.onclick = () => openActionModal(r);
                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs ${iconClass}"><i class="fas ${icon}"></i></div><div><div class="text-sm font-bold text-ink dark:text-gray-200">${r.item || 'è½‰å¸³'}</div><div class="text-[10px] text-gray-400">${r.date} Â· ${r.type === 'è½‰å¸³' ? r.account + ' âœ ' + r.toAccount : r.category}</div></div></div><div class="font-serif font-bold ${amountColor}">${sign}${formatMoney(r.amount)}</div>`;
                list.appendChild(div);
            });
        }

        // Firebase Operations
        async function saveData(collectionName, data) {
            try {
                await window.addDoc(window.collection(window.db, collectionName), data);
                // No need to fetchData(), snapshot listener will auto-update!
            } catch(e) { alert("Save Failed"); console.error(e); }
        }
        
        async function deleteData(collectionName, id) {
            if(!confirm('Delete?')) return;
            try { await window.deleteDoc(window.doc(window.db, collectionName, id)); } catch(e) { alert("Delete Failed"); }
        }

        async function updateData(collectionName, id, data) {
            try { await window.updateDoc(window.doc(window.db, collectionName, id), data); } catch(e) { alert("Update Failed"); }
        }

        // Form Handlers
        document.getElementById('financeForm').addEventListener('submit', async e => {
            e.preventDefault(); const btn = document.getElementById('submitBtn'); btn.disabled=true;
            const data = {
                date: document.getElementById('dateInput').value,
                type: document.getElementById('formType').value,
                account: document.getElementById('accountInput').value,
                category: document.getElementById('categoryInput').value,
                item: document.getElementById('itemInput').value,
                amount: Number(document.getElementById('amountInput').value),
                isClaimable: document.getElementById('isClaimable').checked,
                toAccount: document.getElementById('toAccountInput').value,
                isReimbursed: false,
                timestamp: Date.now()
            };
            
            if(btn.innerText.includes('æ›´æ–°')) { await updateData('records', document.getElementById('editId').value, data); cancelEdit(); }
            else { await saveData('records', data); }
            
            document.getElementById('itemInput').value=''; document.getElementById('amountInput').value=''; btn.disabled=false;
        });

        document.getElementById('accountForm').addEventListener('submit', async e => {
            e.preventDefault(); closeModal('accountModal');
            await saveData('accounts', {
                name: document.getElementById('accName').value,
                type: document.getElementById('accType').value,
                initial: Number(document.getElementById('accInitial').value),
                deadline: document.getElementById('accDeadline').value || 0
            });
        });

        document.getElementById('recurringForm').addEventListener('submit', async e => {
            e.preventDefault(); closeModal('recurringModal');
            await saveData('recurring', {
                item: document.getElementById('recItem').value,
                type: document.getElementById('recType').value,
                category: document.getElementById('recCategory').value,
                amount: Number(document.getElementById('recAmount').value),
                day: document.getElementById('recDay').value,
                account: document.getElementById('recAccount').value
            });
        });

        document.getElementById('budgetForm').addEventListener('submit', async e => {
            e.preventDefault(); closeModal('budgetModal');
            const cat = document.getElementById('budCategory').value;
            const existing = myBudgets.find(b => b.category === cat);
            if(existing) await updateData('budgets', existing.id, { amount: Number(document.getElementById('budAmount').value) });
            else await saveData('budgets', { category: cat, amount: Number(document.getElementById('budAmount').value) });
        });

        // Other UI logic
        function openActionModal(record) { selectedRecordId = record; document.getElementById('actionModal').classList.remove('hidden'); }
        function triggerEdit() { 
            document.getElementById('actionModal').classList.add('hidden'); 
            const r = selectedRecordId; 
            document.getElementById('editId').value = r.id;
            setFormType(r.type);
            document.getElementById('dateInput').value = r.date;
            document.getElementById('accountInput').value = r.account; 
            document.getElementById('amountInput').value = r.amount; 
            document.getElementById('itemInput').value = r.item;
            if(r.type === 'è½‰å¸³') document.getElementById('toAccountInput').value = r.toAccount; 
            else document.getElementById('categoryInput').value = r.category; 
            document.getElementById('isClaimable').checked = r.isClaimable;
            document.getElementById('submitBtn').innerText = "æ›´æ–°ç´€éŒ„"; 
            document.getElementById('cancelEditBtn').classList.remove('hidden'); 
            switchTab('record'); 
        }
        function cancelEdit() { document.getElementById('financeForm').reset(); document.getElementById('submitBtn').innerText = "è¨˜ä¸Šä¸€ç­†"; document.getElementById('submitBtn').onclick = null; document.getElementById('cancelEditBtn').classList.add('hidden'); setFormType('æ”¯å‡º'); }
        function triggerDelete() { document.getElementById('actionModal').classList.add('hidden'); deleteData('records', selectedRecordId.id); }
        async function executeRecurring(id) { const rec = allRecurring.find(r=>r.id===id); if(!confirm('å…¥å¸³?')) return; await saveData('records', {date: new Date().toISOString().split('T')[0], type: rec.type, account: rec.account, category: rec.category, item: rec.item, amount: rec.amount, isClaimable: false, isReimbursed: false}); }
        async function reimburseRecord(id) { if(!confirm('å·²æ ¸éŠ·?')) return; await updateData('records', id, { isReimbursed: true }); }

        // Render Helpers (Manage & Stats)
        function renderManage(){ 
            const recList=document.getElementById('recurringList'); recList.innerHTML='';
            if(allRecurring.length === 0) recList.innerHTML = '<p class="text-xs text-center text-gray-400 py-4 border border-dashed border-gray-300 rounded-xl">ç„¡å›ºå®šæ”¶æ”¯</p>';
            allRecurring.sort((a,b)=>a.day-b.day).forEach(rec=>{
                const div=document.createElement('div'); div.className='paper-card p-3 rounded-xl flex justify-between items-center mb-2';
                div.innerHTML=`<div class="flex items-center gap-3"><div class="flex flex-col items-center bg-sand/30 p-1.5 rounded-lg w-10"><span class="text-[9px] text-gray-500 uppercase">Day</span><span class="font-serif font-bold text-ink">${rec.day}</span></div><div><div class="text-sm font-bold text-ink dark:text-gray-200">${rec.item}</div><div class="text-[10px] text-gray-400">${rec.account} Â· ${rec.category}</div></div></div><div class="flex items-center gap-2"><span class="font-serif text-sm ${rec.type=='æ”¯å‡º'?'text-gray-500':'text-sage'}">$${formatMoney(rec.amount)}</span><button onclick="executeRecurring('${rec.id}')" class="bg-ink text-white p-1.5 rounded shadow text-[10px]"><i class="fas fa-check"></i></button><button onclick="deleteData('recurring', '${rec.id}')" class="text-gray-300 hover:text-red-400 p-1.5"><i class="fas fa-times"></i></button></div>`;
                recList.appendChild(div);
            });
            const claimList=document.getElementById('claimList'); claimList.innerHTML='';
            const claims=allRecords.filter(r=>r.isClaimable&&!r.isReimbursed);
            if(claims.length===0) claimList.innerHTML='<p class="text-xs text-center text-gray-400 py-4">ç„¡å¾…æ ¸éŠ·é …ç›®</p>';
            claims.forEach(c=>{const div=document.createElement('div');div.className='paper-card p-3 rounded-xl flex justify-between items-center mb-2 border-l-4 border-terra';div.innerHTML=`<div><div class="text-sm font-bold">${c.item}</div><div class="text-[10px] text-gray-400">${c.date} Â· ${c.account}</div></div><div class="flex items-center gap-2"><span class="font-serif font-bold text-terra">$${formatMoney(c.amount)}</span><button onclick="reimburseRecord('${c.id}')" class="text-[10px] bg-white border border-gray-200 px-2 py-1 rounded shadow-sm hover:bg-gray-50">æ ¸éŠ·</button></div>`;claimList.appendChild(div)}) 
        }

        function renderStats() {
            const ctxCat=document.getElementById('categoryChart').getContext('2d');
            const thisMonth=allRecords.filter(r=>{const d=new Date(r.date); const now=new Date(); return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear()&&r.type==='æ”¯å‡º'});
            let catMap={}; thisMonth.forEach(r=>catMap[r.category]=(catMap[r.category]||0)+r.amount);
            if(chartInstances.cat)chartInstances.cat.destroy();
            chartInstances.cat=new Chart(ctxCat,{type:'doughnut',data:{labels:Object.keys(catMap),datasets:[{data:Object.values(catMap),backgroundColor:['#d68c78','#eaddcf','#84a98c','#cdb4db','#9ca3af','#f4a261'],borderWidth:0}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
            
            const bList = document.getElementById('budgetList'); bList.innerHTML = ''; 
            if(myBudgets.length === 0) bList.innerHTML = '<p class="text-xs text-gray-400 text-center">ç„¡é ç®—</p>';
            myBudgets.forEach(b => { 
                const spent = catMap[b.category] || 0; 
                const pct = Math.min((spent / b.amount)*100, 100); 
                const color = pct > 90 ? 'bg-red-400' : 'bg-sage'; 
                const div = document.createElement('div'); 
                div.innerHTML = `<div class="flex justify-between text-xs mb-1"><span class="font-bold">${b.category}</span><span>$${formatMoney(spent)} / $${formatMoney(b.amount)}</span></div><div class="w-full bg-gray-200 h-1.5 rounded-full"><div class="${color} h-full rounded-full transition-all duration-500" style="width:${pct}%"></div></div>`; 
                bList.appendChild(div); 
            }); 
        }

        function renderNetWorthChart(currentNetWorth) {
            const ctx = document.getElementById('netWorthChart').getContext('2d');
            let labels = [], dataPoints = [];
            for(let i=5; i>=0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); labels.push(`${d.getMonth()+1}æœˆ`); dataPoints.push(currentNetWorth - (Math.random() * 2000 * i)); } 
            dataPoints[5] = currentNetWorth;
            if(chartInstances.nw) chartInstances.nw.destroy();
            chartInstances.nw = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'æ·¨è³‡ç”¢', data: dataPoints, borderColor: '#84a98c', tension: 0.4, fill: true, backgroundColor: 'rgba(132, 169, 140, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } });
        }

        // Utils
        function setFormType(t){document.getElementById('formType').value=t;const expBtn=document.getElementById('btnExpense'),incBtn=document.getElementById('btnIncome'),transBtn=document.getElementById('btnTransfer'),claimSec=document.getElementById('claimSection'); [expBtn,incBtn,transBtn].forEach(b=>b.className='flex-1 text-sm text-gray-400 pb-2 transition'); const activeBtn=t==='æ”¯å‡º'?expBtn:(t==='æ”¶å…¥'?incBtn:transBtn); const color=t==='æ”¯å‡º'?'terra':(t==='æ”¶å…¥'?'sage':'gray-500'); activeBtn.className=`flex-1 text-sm font-bold pb-2 border-b-2 border-${color} text-${color} transition`; if(t==='è½‰å¸³'){document.getElementById('normalFields').classList.add('hidden');document.getElementById('toAccountField').classList.remove('hidden');claimSec.classList.add('hidden');document.getElementById('fromLabel').innerText="è½‰å‡º";document.getElementById('itemInput').value="è½‰å¸³"}else{document.getElementById('normalFields').classList.remove('hidden');document.getElementById('toAccountField').classList.add('hidden');claimSec.classList.remove('hidden');document.getElementById('fromLabel').innerText="å¸³æˆ¶";if(document.getElementById('itemInput').value==="è½‰å¸³")document.getElementById('itemInput').value=""} updateCategories()}
        function updateCategories(){document.getElementById('categoryInput').innerHTML=categories[document.getElementById('formType').value]?.map(c=>`<option>${c}</option>`).join('')||''}
        function updateRecCats(){document.getElementById('recCategory').innerHTML=categories[document.getElementById('recType').value].map(c=>`<option>${c}</option>`).join('')}
        function switchTab(tab,btn){document.querySelectorAll('.page-content').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+tab).classList.add('active');if(btn){document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('nav-active'));btn.classList.add('nav-active')}if(tab==='stats')renderStats();if(tab==='assets')renderAssets();}
        function toggleDeadline() { document.getElementById('deadlineField').className = document.getElementById('accType').value === 'credit' ? 'flex items-center border-b border-gray-300' : 'hidden'; }
        function openRecurringModal(){document.getElementById('recurringModal').classList.remove('hidden');setTimeout(()=>{document.getElementById('recModalContent').classList.remove('scale-95','opacity-0');document.getElementById('recModalContent').classList.add('scale-100','opacity-100')},10)}
        function openAccountModal(){document.getElementById('accountModal').classList.remove('hidden');setTimeout(()=>{document.getElementById('accModalContent').classList.remove('scale-95','opacity-0');document.getElementById('accModalContent').classList.add('scale-100','opacity-100')},10)}
        function openBudgetModal(){document.getElementById('budgetModal').classList.remove('hidden');setTimeout(()=>{document.getElementById('budModalContent').classList.remove('scale-95','opacity-0');document.getElementById('budModalContent').classList.add('scale-100','opacity-100')},10)}
        function closeModal(id){let c=document.getElementById(id.replace('Modal','ModalContent'));if(c){c.classList.remove('scale-100','opacity-100');c.classList.add('scale-95','opacity-0');}setTimeout(()=>document.getElementById(id).classList.add('hidden'),200)}
        function enterPin(n){if(n==='del')currentPin=currentPin.slice(0,-1);else if(currentPin.length<4)currentPin+=n;for(let i=1;i<=4;i++)document.getElementById('dot'+i).className=i<=currentPin.length?'pin-dot filled':'pin-dot';if(currentPin.length===4){if(!storedPin){localStorage.setItem('lumiere_pin',currentPin);storedPin=currentPin;alert('PIN Set!');document.getElementById('lockScreen').style.display='none'}else if(currentPin===storedPin){document.getElementById('lockScreen').style.display='none'}else{document.getElementById('lockMsg').innerText="Wrong PIN";currentPin='';for(let i=1;i<=4;i++)document.getElementById('dot'+i).className='pin-dot'}}}
        function forgetPin(){if(confirm('é‡è¨­ PIN ç¢¼å°‡æ¸…é™¤æœ¬åœ°å¿«å–ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ')){localStorage.removeItem('lumiere_pin');location.reload()}}
        function exportCSV() { const csv = Papa.unparse(allRecords); const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"}); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Lumiere_${new Date().toISOString().slice(0,10)}.csv`; link.click(); }
        const formatMoney=(n)=>new Intl.NumberFormat('zh-TW').format(n);
        if(localStorage.theme==='dark'||(!('theme'in localStorage)&&window.matchMedia('(prefers-color-scheme: dark)').matches))document.documentElement.classList.add('dark');
        document.getElementById('themeToggle').addEventListener('click',()=>{document.documentElement.classList.toggle('dark');localStorage.theme=document.documentElement.classList.contains('dark')?'dark':'light';if(chartInstances.cat)renderStats()});
    </script>
</body>
</html>
